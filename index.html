<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo - A GARAGEM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="<?= ScriptApp.getService().getUrl() ?>?page=manifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="A Garagem">
    <title>Dashboard - A Garagem</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #D4AF37;
            --primary-dark: #B8860B;
            --accent: #A50000;
            --dark: #0A0A0A;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass: rgba(255, 255, 255, 0.1);
            --text: #FFFFFF;
            --text-muted: #A0A0A0;
            --bg: #050508;
            --success: #00E676;
            --warning: #FFAB00;
        }

        /* Styles for Portal */
        .portal-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            gap: 2rem;
        }

        .portal-title {
            text-align: center;
            margin-bottom: 2rem;
        }

        .portal-title h1 {
            font-size: 2.5rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .portal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 1000px;
        }

        .portal-card {
            background: var(--card-bg);
            border: 1px solid var(--glass);
            border-radius: 24px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .portal-card:hover {
            transform: translateY(-10px);
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
        }

        .portal-card i {
            font-size: 4rem;
            color: var(--primary);
        }

        .portal-card h3 {
            font-size: 1.5rem;
            text-transform: uppercase;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            background-image: radial-gradient(circle at 50% 0%, #1a1505 0%, #050508 100%);
        }

        .top-bar {
            background: #09090c;
            color: #666;
            font-size: 0.65rem;
            padding: 5px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1a1a24;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 101;
        }

        .top-bar b {
            color: var(--primary);
        }

        header {
            background: rgba(13, 13, 18, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 5%;
            border-bottom: 1px solid var(--glass);
            position: sticky;
            top: 25px;
            /* Altura aproximada do top-bar */
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .brand span {
            color: var(--primary);
        }

        .nav-container {
            display: flex;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 0.5rem;
            border-radius: 50px;
            margin: 2rem auto;
            width: fit-content;
            border: 1px solid var(--glass);
        }

        .nav-item {
            padding: 0.8rem 2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-muted);
        }

        .nav-item.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .container {
            padding: 0 2rem 4rem 2rem;
            max-width: 1200px;
            margin: auto;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--glass);
            padding: 1.5rem;
            border-radius: 20px;
            position: relative;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-card small {
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--glass);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--glass);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .img-estoque {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--glass);
            color: white;
        }

        .btn-outline:hover {
            background: var(--glass);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: #151520;
            padding: 2.5rem;
            border-radius: 28px;
            width: 95%;
            max-width: 550px;
            border: 1px solid var(--primary);
        }

        input,
        select {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0 1.2rem 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass);
            border-radius: 12px;
            color: white;
            font-family: inherit;
        }

        select option {
            background: #1a1a2e;
            color: white;
        }

        .comanda-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.2rem;
        }

        .comanda-item {
            background: var(--card-bg);
            border: 1px solid var(--glass);
            padding: 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            position: relative;
        }

        .status-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.65rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 700;
        }

        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(20, 20, 30, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            max-width: 350px;
            border-left: 5px solid var(--primary);
            animation: slideIn 0.3s ease-out forwards, fadeOut 0.5s ease-in forwards var(--delay);
            opacity: 0;
            transform: translateX(100%);
        }

        .toast.error {
            border-left: 5px solid #ff4444;
        }

        .toast.ready {
            border-left: 5px solid var(--success);
            background: rgba(10, 30, 10, 0.95);
        }

        @keyframes slideIn {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }

            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateX(0);
            }

            100% {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d0d12;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: #1a1a24;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: #252533;
            border: 1px solid #444;
            border-radius: 12px;
            color: white;
            text-align: center;
            font-size: 20px;
            letter-spacing: 5px;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), #b8860b);
            border: none;
            border-radius: 12px;
            color: #000;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
        }

        .login-box button:active {
            transform: scale(0.98);
        }

        @media print {
            @page {
                size: 80mm auto;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            body {
                background: white !important;
                color: black !important;
                margin: 0;
                padding: 0;
            }

            header,
            .nav-container,
            .container,
            .overlay,
            .loader-overlay,
            .toast-container {
                /* Added .toast-container to hide toasts during print */
                display: none !important;
            }

            /* Only show the overlay that contains the print-area */
            #modalVisualizar.overlay {
                display: block !important;
                position: absolute !important;
                top: 0;
                left: 0;
                width: 100% !important;
                background: white !important;
                z-index: 9999;
            }

            .modal-box {
                border: none !important;
                width: 72mm !important;
                max-width: 100% !important;
                margin: 0 auto !important;
                padding: 10px 5px !important;
                background: white !important;
                box-shadow: none !important;
                color: black !important;
                font-family: 'Courier New', Courier, monospace;
            }

            #print-area {
                display: block !important;
            }

            /* Hide the close buttons/actions inside the modal during print */
            .modal-box>div:not(#print-area) {
                display: none !important;
            }

            #v-nome {
                font-size: 20px !important;
                text-align: center !important;
                margin-bottom: 20px !important;
                color: black !important;
            }

            #v-total {
                color: black !important;
                font-size: 18px !important;
            }
        }

        @keyframes pulse-warn {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 152, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 152, 0, 0);
            }
        }

        /* Bot√£o de Instala√ß√£o PWA */
        #install-button {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), #b8860b);
            color: #000;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            z-index: 9999;
            transition: all 0.3s ease;
            animation: pulse-install 2s infinite;
        }

        #install-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.6);
        }

        #install-button i {
            margin-right: 8px;
        }

        @keyframes pulse-install {
            0% {
                box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            }

            50% {
                box-shadow: 0 5px 30px rgba(212, 175, 55, 0.7);
            }

            100% {
                box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            }
        }
    </style>
</head>

<body>
    <!-- PORTAL DE ENTRADA -->
    <div id="view-portal" class="portal-container">
        <div class="portal-title">
            <i class="fas fa-beer" style="font-size: 4rem; color: var(--primary); margin-bottom: 1rem;"></i>
            <h1>A GARAGEM</h1>
            <p style="color: var(--text-muted)">Selecione o m√≥dulo de acesso</p>
        </div>
        <div class="portal-grid">
            <div class="portal-card" onclick="irParaLogin()">
                <i class="fas fa-user-shield"></i>
                <h3>Administrativo</h3>
                <small style="color: var(--text-muted)">Gest√£o, Estoque e Relat√≥rios</small>
            </div>
            <div class="portal-card" onclick="irParaModulo('garcom')">
                <i class="fas fa-user-tie"></i>
                <h3>Gar√ßom</h3>
                <small style="color: var(--text-muted)">Lan√ßamento de Pedidos</small>
            </div>
            <div class="portal-card" onclick="irParaModulo('cozinha')">
                <i class="fas fa-utensils"></i>
                <h3>Cozinha</h3>
                <small style="color: var(--text-muted)">Painel de Preparo</small>
            </div>
        </div>
    </div>

    <!-- Overlay de Login -->
    <div id="login-overlay" style="display: none;">
        <div class="login-box">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2>Acesso Admin</h2>
            <p style="color: #888; margin-bottom: 20px;">Digite a senha de administrador.</p>
            <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10">
            <div style="display: flex; gap: 10px;">
                <button onclick="tentarLogin()" style="flex: 2;">ENTRAR</button>
                <button onclick="voltarAoPortal()"
                    style="flex: 1; background: var(--glass); color: white;">VOLTAR</button>
            </div>
            <p id="login-err" style="color: #ff4444; font-size: 0.8rem; margin-top: 15px; display: none;">Senha
                incorreta.</p>
        </div>
    </div>

    <!-- Bot√£o de Instala√ß√£o PWA -->
    <button id="install-button"><i class="fas fa-download"></i>Instalar App</button>

    <!-- CONTE√öDO PRINCIPAL (ADMIN) -->
    <div id="view-admin" style="display: none;">
        <div class="top-bar no-print">
            <span><i class="fas fa-code"></i> Developed by: <b>J.A SOFTWARE & SOLUTION</b></span>
            <span><i class="fab fa-whatsapp"></i> (87) 9 8143-6052</span>
        </div>
        <header>
            <div class="brand">üç∫ A GARAGEM <span>PETISCARIA</span></div>
        </header>

        <div class="nav-container no-print">
            <div class="nav-item active" onclick="switchTab('tab-dash', this)">Dashboard</div>
            <div class="nav-item" onclick="switchTab('tab-estoque', this)">Estoque</div>
            <div class="nav-item" onclick="switchTab('tab-vd', this)">Venda Direta</div>
            <div class="nav-item" onclick="voltarAoPortal()" style="color: var(--accent)"><i
                    class="fas fa-sign-out-alt"></i> Sair</div>
        </div>

        <div class="container">
            <!-- DASHBOARD -->
            <div id="tab-dash" class="tab-content">
                <div class="card" style="padding: 1rem 2rem; margin-bottom: 2rem;">
                    <div style="display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
                        <b>In√≠cio:</b>
                        <input type="date" id="dash-inicio" style="width:auto; margin:0" onchange="carregarDash()">
                        <b>Fim:</b>
                        <input type="date" id="dash-fim" style="width:auto; margin:0" onchange="carregarDash()">
                        <button class="btn btn-outline" onclick="setFiltroHoje()">Hoje</button>
                        <button class="btn btn-outline" onclick="setFiltroMes()">M√™s Atual</button>
                        <button class="btn btn-outline" onclick="limparFiltro()">Limpar</button>
                    </div>
                </div>

                <div class="dash-grid">
                    <div class="stat-card">
                        <small>Total Vendido</small>
                        <div id="d-total" class="stat-value" style="color: var(--success);">R$ 0,00</div>
                    </div>
                    <div class="stat-card">
                        <small>Itens Vendidos</small>
                        <div id="d-qtd" class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <small>Produtos Cr√≠ticos</small>
                        <div id="d-criticos" class="stat-value" style="color: var(--warning);">0</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin:0">üìã Comandas & Vendas Recentes</h3>
                        <button class="btn btn-outline" style="padding: 5px 15px; font-size: 0.8rem;"
                            onclick="toggleComandas()">
                            <span id="txt-toggle">Recolher</span> <i id="icon-toggle" class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div id="container-comandas-hist">
                        <div class="comanda-grid" id="lista-comandas-hist"></div>
                    </div>
                </div>

                <div class="dash-grid">
                    <div class="card">
                        <h3>üèÜ Top 5 (M√©dia de Venda Di√°ria)</h3>
                        <table style="margin-top:1rem;" id="d-ranking"></table>

                        <h3 style="margin-top:2rem;">üìÇ M√©dia de Produtos por Categoria</h3>
                        <div id="d-ranking-cat" style="margin-top:1rem;"></div>
                    </div>
                    <div class="card">
                        <h3>üí≥ Vendas por Pagamento</h3>
                        <div id="d-pagamentos" style="margin-top:1rem; display:flex; flex-direction:column; gap:10px;">
                        </div>
                    </div>
                </div>

                <div class="card" id="card-fiados" style="display:none; margin-top: 2rem;">
                    <div
                        style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin:0">üö© Controle de Fiados (D√≠vidas Ativas)</h3>
                        <span id="fiados-count"
                            style="background: var(--accent); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">0</span>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width:100%; font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Ref / Mesa</th>
                                    <th align="right">Valor</th>
                                    <th align="center">Tempo</th>
                                    <th align="right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="lista-fiados"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ESTOQUE -->
            <div id="tab-estoque" class="tab-content" style="display:none">
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0;">Gest√£o de Estoque</h2>
                        <button class="btn btn-primary" onclick="abrirNovoProduto()">+ Novo Produto</button>
                    </div>
                    <div id="lista-estoque" style="overflow-x: auto;"></div>
                </div>
            </div>

            <div id="tab-vd" class="tab-content" style="display:none">
                <div class="card">
                    <h3>‚ö° Venda R√°pida (Direta)</h3>
                    <div style="position: relative; margin-top: 1.5rem;">
                        <input type="text" id="vd-busca" placeholder="üîç Buscar produto..."
                            oninput="buscarVD(this.value)" onfocus="buscarVD(this.value)">
                        <div id="vd-drop"
                            style="position: absolute; width: 100%; background: #1a1a2e; border-radius: 12px; border: 1px solid var(--glass); display: none; max-height: 250px; overflow-y: auto; z-index: 500;">
                        </div>
                    </div>

                    <table id="vd-carrinho" style="margin-top: 1.5rem;">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd</th>
                                <th align="right">Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div
                        style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: end;">
                        <div>
                            <label style="font-size: 0.8rem; color: var(--text-muted);">Forma de Pagamento</label>
                            <select id="vd-pagamento" style="margin-bottom:0" onchange="toggleVdCliente()">
                                <option value="Dinheiro">üíµ Dinheiro</option>
                                <option value="Pix">üì± Pix</option>
                                <option value="D√©bito">üí≥ D√©bito</option>
                                <option value="Cr√©dito">üí≥ Cr√©dito</option>
                                <option value="Voucher">üéüÔ∏è Voucher</option>
                                <option value="Fiado">üö© Fiado</option>
                            </select>
                        </div>
                        <div id="vd-cliente-cont" style="display:none">
                            <label style="font-size: 0.8rem; color: var(--text-muted);">Nome do Cliente (Fiado)</label>
                            <input type="text" id="vd-cliente" placeholder="Quem est√° devendo?" style="margin-bottom:0">
                        </div>
                        <div>
                            <h2 id="vd-total" style="color: var(--primary); margin-bottom: 0.5rem; text-align: right;">
                                R$
                                0,00</h2>
                            <button class="btn btn-primary" style="width: 100%;" onclick="finalizarVD()">EFETUAR
                                VENDA</button>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- Fim container -->
    </div> <!-- Fim view-admin -->

    <div id="toast-container" class="toast-container"></div>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top:15px; font-weight:600;"></p>
    </div>

    <!-- Modal Visualizar Comanda -->
    <div id="modalVisualizar" class="overlay">
        <div class="modal-box">
            <div id="print-area">
                <div
                    style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 20px;">
                    <h1 style="margin:0; font-size: 24px; text-transform: uppercase;">A GARAGEM</h1>
                    <p style="margin:2px 0; font-size: 14px; font-weight: bold;">PETISCARIA & CERVEJARIA</p>
                    <p
                        style="margin:5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; font-size: 12px;">
                        EXTRATO DE CONSUMO</p>
                </div>
                <h2 id="v-nome" style="margin-bottom: 1.5rem; text-align: center;">Mesa</h2>
                <table id="v-itens" style="width: 100%; font-size: 12px; border-collapse: collapse;"></table>
                <div style="margin-top: 1.5rem; text-align: right; border-top: 1px dashed #000; padding-top: 10px;">
                    <h3 id="v-total" style="font-size: 1.5rem; color: #D4AF37;">Total: R$ 0,00</h3>
                </div>
                <div style="text-align:center; margin-top: 30px; border-top: 1px solid #000; padding-top: 10px;"
                    class="print-only">
                    <p style="font-size: 12px; font-weight: bold;">BOHEMIA PURO MALTE</p>
                    <p style="font-size: 11px; margin-top: 5px;">Obrigado pela prefer√™ncia!</p>
                    <div
                        style="margin-top: 15px; border-top: 1px dotted #000; padding-top: 5px; font-size: 9px; opacity: 0.8;">
                        Developed by: J.A Software & Solution<br>
                        (87) 9 8143-6052
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 2rem;" class="no-print">
                <button class="btn btn-primary" style="flex: 1;" onclick="window.print()">üñ®Ô∏è Imprimir Cupom</button>
                <button class="btn btn-outline" onclick="fecharModais()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Editar/Novo Produto -->
    <div id="modalEdit" class="overlay">
        <div class="modal-box">
            <h3 id="edit-title">üìù Editar Produto</h3>
            <div style="margin-top: 1.5rem;">
                <label>Nome do Produto</label>
                <input type="text" id="edit-nome" placeholder="Ex: Cerveja Lata">

                <label>Categoria</label>
                <select id="edit-categoria">
                    <option value="Refei√ß√µes">üçΩÔ∏è Refei√ß√µes</option>
                    <option value="Petiscos">üçü Petiscos</option>
                    <option value="Bebidas">ü•§ Bebidas</option>
                    <option value="Cervejas">üç∫ Cervejas</option>
                    <option value="Bebidas Quentes">ü•É Bebidas Quentes</option>
                    <option value="Outros">üì¶ Outros</option>
                </select>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>Pre√ßo Venda</label><input type="number" id="edit-preco" step="0.01"></div>
                    <div><label id="label-estoque">Aumentar Estoque em</label><input type="number" id="edit-estoque">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div><label>Estoque M√≠nimo</label><input type="number" id="edit-minimo"></div>
                    <div><label>ID / C√≥digo</label><input type="text" id="edit-codigo" placeholder="Auto-gerado"></div>
                </div>

                <label>URL da Imagem</label>
                <input type="text" id="edit-img" placeholder="https://...">

                <div style="display: flex; gap: 10px; margin-top: 1rem;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="salvarEdicao()">Salvar</button>
                    <button class="btn btn-outline" onclick="fecharModais()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        // CONFIGURA√á√ÉO VERCEL -> GOOGLE
        // COLE SEU LINK DO GOOGLE SCRIPT AQUI PARA FUNCIONAR NA VERCEL:
        const URL_GAS = "https://script.google.com/macros/s/AKfycbyk58Cyx04GHujrrEFN8OP_n6VUVnWCR0URrWKtx5IZcLaEsqIk_VpPkvbxKZSbuZ0c/exec"; // EX: https://script.google.com/macros/s/.../exec

        // POLYFILL GOOGLE SCRIPT RUN (Para funcionamento na Vercel)
        (function () {
            if (typeof google === 'undefined') window.google = {};
            if (typeof google.script === 'undefined') google.script = {};
            function createRunner(handlers) {
                return new Proxy({}, {
                    get: function (target, prop) {
                        if (prop === 'withSuccessHandler') return (cb) => createRunner({ ...handlers, success: cb });
                        if (prop === 'withFailureHandler') return (eb) => createRunner({ ...handlers, failure: eb });
                        return function (...args) {
                            fetch(URL_GAS, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ function: prop, args: args }), redirect: 'follow' })
                                .then(r => r.json()).then(res => {
                                    if (res && res.sucesso === false && handlers.failure) handlers.failure({ message: res.erro || "Erro no servidor" });
                                    else if (handlers.success) handlers.success(res);
                                }).catch(err => { if (handlers.failure) handlers.failure(err); });
                        };
                    }
                });
            }
            google.script.run = createRunner({ success: null, failure: null });
        })();

        let estoqueCache = [], carrinhoVD = [], editingCode = null;

        function mostrarCarregando(t) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loader-text').innerText = t;
        }
        function esconderCarregando() { document.getElementById('loader').style.display = 'none'; }

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.setProperty('--delay', `${duration / 1000}s`); // Set CSS variable for animation delay

            toastContainer.appendChild(toast);

            // Remove toast after animation
            setTimeout(() => {
                toast.remove();
            }, duration + 500); // 500ms for fadeOut animation
        }

        function switchTab(id, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            el.classList.add('active');
            if (id === 'tab-dash') carregarDash();
            if (id === 'tab-estoque') carregarEstoque();
        }

        let notificacoesVistas = new Set();
        function checarNotificacoes() {
            google.script.run.withSuccessHandler(lista => {
                if (!Array.isArray(lista)) return;
                lista.forEach(n => {
                    let chave = n.idComanda + n.nome + n.qtd;
                    if (!notificacoesVistas.has(chave)) {
                        showToast(`üç≥ PRONTO: ${n.nome} (${n.qtd}x) - Mesa: ${n.mesa}`, "ready", 30000);
                        notificacoesVistas.add(chave);
                    }
                });
            }).getNotificacoesCozinha();
        }

        // Iniciar polling de notifica√ß√µes a cada 10 segundos e Dashboard a cada 30 segundos
        setInterval(checarNotificacoes, 10000);
        setInterval(() => {
            if (document.getElementById('tab-dash').style.display !== 'none') {
                carregarDash();
            }
        }, 30000);

        function carregarDash() {
            const inicio = document.getElementById('dash-inicio').value;
            const fim = document.getElementById('dash-fim').value;

            google.script.run.withSuccessHandler(lista => {
                let html = "";
                if (Array.isArray(lista)) {
                    lista.forEach(c => {
                        let match = true;
                        if (inicio && c.data < inicio) match = false;
                        if (fim && c.data > fim) match = false;

                        if (match) {
                            const borderStyle = c.isAntiga && c.status === 'ABERTA' ? 'border: 2px solid #ff9800; animation: pulse-warn 2s infinite;' : '';
                            const alertIcon = c.isAntiga && c.status === 'ABERTA' ? '<i class="fas fa-clock" style="color:#ff9800; margin-right:5px;"></i>' : '';

                            html += `
                                <div class="comanda-item" style="${borderStyle}" onclick="visualizar('${c.id}', '${c.nome}')">
                                    <span class="status-badge" style="background:${c.status === 'ABERTA' ? 'rgba(0,230,118,0.2)' : 'rgba(255,255,255,0.1)'}; color:${c.status === 'ABERTA' ? 'var(--success)' : 'var(--text-muted)'}">${c.status}</span>
                                    <b>${alertIcon}${c.nome}</b>
                                    ${c.cliente && c.cliente !== 'Balc√£o' ? `<br><small style="color:var(--primary); font-size:0.7rem">üë§ ${c.cliente}</small>` : ''}<br>
                                    <span style="color:${c.status === 'ABERTA' ? 'var(--success)' : 'var(--text)'}; font-weight:700">R$ ${(c.total || 0).toFixed(2)}</span>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">${c.dataExibicao}</div>
                                </div>`;
                        }
                    });
                }
                document.getElementById('lista-comandas-hist').innerHTML = (Array.isArray(lista) ? html : '') || 'Sem dados.';
            }).listarTodasComandas(inicio, fim);

            google.script.run.withSuccessHandler(d => {
                if (!d) return;
                document.getElementById('d-total').innerText = 'R$ ' + (d.totalVendido || 0).toFixed(2);
                document.getElementById('d-qtd').innerText = d.qtdVendida || 0;
                document.getElementById('d-criticos').innerText = d.criticos || 0;

                // Renderizar Ranking com M√©dia Di√°ria
                document.getElementById('d-ranking').innerHTML = `
                    <thead>
                        <tr>
                            <th style="font-size:0.7rem">PRODUTO</th>
                            <th style="font-size:0.7rem; text-align:center"> TOTAL</th>
                            <th style="font-size:0.7rem; text-align:right">M√âDIA/DIA</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${(d.ranking || []).map(p => `
                        <tr>
                            <td style="padding: 10px 5px;"><b>${p.nome}</b></td>
                            <td align="center">${p.qtd}x</td>
                            <td align="right"><b>${(p.mediaDiaria || 0).toFixed(1)}/dia</b></td>
                        </tr>
                    `).join('')}
                    </tbody>` || '<tr><td colspan="3" align="center">Nenhuma venda de produto registrada.</td></tr>';

                // Renderizar Ranking de Produtos Agrupados por Categoria
                let groupedHtml = "";
                let todosProds = d.todosProdutos || [];
                let cats = [...new Set(todosProds.map(p => p.categoria))].sort();

                if (d.todosProdutos.length === 0) {
                    groupedHtml = '<p style="text-align:center; color:var(--text-muted)">Nenhuma venda registrada.</p>';
                } else {
                    cats.forEach(cat => {
                        let prods = todosProds.filter(p => p.categoria === cat);
                        groupedHtml += `
                            <div style="margin-bottom: 20px;">
                                <h4 style="color:var(--accent); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px; margin-bottom:10px;">${cat}</h4>
                                <table style="width:100%">
                                    <thead>
                                        <tr>
                                            <th style="font-size:0.6rem; text-align:left">PRODUTO</th>
                                            <th style="font-size:0.6rem; text-align:center">TOTAL</th>
                                            <th style="font-size:0.6rem; text-align:right">M√âDIA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${prods.map(p => `
                                            <tr>
                                                <td style="font-size:0.85rem"><b>${p.nome}</b></td>
                                                <td align="center" style="font-size:0.85rem">${p.qtd}x</td>
                                                <td align="right" style="font-size:0.85rem"><b>${(p.mediaDiaria || 0).toFixed(1)}/dia</b></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    });
                }
                document.getElementById('d-ranking-cat').innerHTML = groupedHtml;

                // Renderizar Pagamentos
                let pagHtml = "";
                for (let m in d.metodos) {
                    pagHtml += `
                        <div style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.03); border-radius:10px;">
                            <span>${m}</span>
                            <b>R$ ${d.metodos[m].toFixed(2)}</b>
                        </div>`;
                }
                document.getElementById('d-pagamentos').innerHTML = pagHtml || 'Nenhum pagamento.';

                // Renderizar Fiados
                if (d.fiados && d.fiados.length > 0) {
                    document.getElementById('card-fiados').style.display = 'block';
                    document.getElementById('fiados-count').innerText = d.fiados.length;
                    document.getElementById('lista-fiados').innerHTML = d.fiados.map(f => `
                        <tr>
                            <td>${f.data}</td>
                            <td><b>${f.cliente}</b></td>
                            <td><small>${f.mesa}</small></td>
                            <td align="right"><b>R$ ${f.valor.toFixed(2)}</b></td>
                            <td align="center"><span style="color:${f.dias > 30 ? 'var(--accent)' : 'var(--warning)'}">${f.dias} dias</span></td>
                            <td align="right">
                                <button class="btn btn-outline" style="padding: 4px 8px; font-size: 0.7rem;" onclick="visualizar('${f.id}', '${f.cliente}')">üîé Ver</button>
                                <button class="btn btn-primary" style="padding: 4px 8px; font-size: 0.7rem; margin-left:5px" onclick="abrirPagamentoFiado('${f.id}', '${f.cliente}', ${f.valor})">üí∞ Pagar</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('card-fiados').style.display = 'none';
                }
            }).getDashboardData(inicio, fim);
        }

        function abrirPagamentoFiado(id, cliente, total) {
            // Reaproveita a l√≥gica de visualiza√ß√£o para mostrar o que o cliente deve antes de pagar?
            // Para simplificar agora, apenas abre a interface de pagamento para essa comanda
            visualizar(id, cliente);
        }

        function carregarEstoque() {
            google.script.run.withSuccessHandler(data => {
                estoqueCache = data;
                if (Array.isArray(data)) {
                    data.forEach(p => {
                        html += `
                        <tr>
                            <td><img src="${p.imagem}" class="img-estoque"></td>
                            <td><b>${p.nome}</b><br><small>${p.codigo}</small></td>
                            <td><small>${p.categoria}</small></td>
                            <td>R$ ${p.preco.toFixed(2)}</td>
                            <td style="color:${p.critico ? 'var(--primary)' : 'inherit'}">${p.estoque} ${p.critico ? '‚ö†Ô∏è' : ''}</td>
                            <td><button class="btn btn-outline" style="padding: 0.5rem 1rem;" onclick="abrirEdicao('${p.codigo}')">Editar</button></td>
                        </tr>`;
                    });
                }
                document.getElementById('lista-estoque').innerHTML = html + '</tbody></table>';
            }).listarEstoque();
        }

        function abrirNovoProduto() {
            editingCode = null;
            document.getElementById('edit-title').innerText = "üÜï Novo Produto";
            document.getElementById('label-estoque').innerText = "Estoque Inicial";
            document.getElementById('edit-nome').value = "";
            document.getElementById('edit-preco').value = "";
            document.getElementById('edit-estoque').value = "";
            document.getElementById('edit-minimo').value = "";
            document.getElementById('edit-codigo').value = "";
            document.getElementById('edit-img').value = "";
            document.getElementById('modalEdit').style.display = 'flex';
        }

        function abrirEdicao(cod) {
            let p = estoqueCache.find(x => x.codigo === cod);
            editingCode = cod;
            document.getElementById('edit-title').innerText = "üìù Editar Produto";
            document.getElementById('label-estoque').innerText = "Adicionar ao Estoque";
            document.getElementById('edit-nome').value = p.nome;
            document.getElementById('edit-categoria').value = p.categoria || "Bebida";
            document.getElementById('edit-preco').value = p.preco;
            document.getElementById('edit-estoque').value = 0;
            document.getElementById('edit-minimo').value = p.minimo;
            document.getElementById('edit-codigo').value = p.codigo;
            document.getElementById('edit-img').value = p.imagem;
            document.getElementById('modalEdit').style.display = 'flex';
        }

        function salvarEdicao() {
            let p = {
                codigo: document.getElementById('edit-codigo').value || null,
                nome: document.getElementById('edit-nome').value,
                categoria: document.getElementById('edit-categoria').value,
                preco: parseFloat(document.getElementById('edit-preco').value),
                estoque: parseFloat(document.getElementById('edit-estoque').value),
                minimo: parseFloat(document.getElementById('edit-minimo').value),
                imagem: document.getElementById('edit-img').value
            };
            if (!p.nome || isNaN(p.preco)) {
                alert("Preencha Nome e Pre√ßo!");
                return;
            }

            mostrarCarregando("Salvando...");
            const func = editingCode ? 'salvarEdicaoProduto' : 'adicionarProduto';
            google.script.run.withSuccessHandler(() => {
                esconderCarregando(); fecharModais(); carregarEstoque();
            })[func](p);
        }

        function visualizar(id, nome) {
            document.getElementById('v-nome').innerText = nome;
            // Limpar dados anteriores para evitar que apare√ßam antes da nova carga
            document.getElementById('v-itens').innerHTML = '<tr><td colspan="3" align="center">Carregando...</td></tr>';
            document.getElementById('v-total').innerText = 'Total: R$ 0,00';

            google.script.run.withSuccessHandler(itens => {
                let t = 0;
                let produtos = itens.filter(i => {
                    let cat = (i.category || i.categoria || i.cat || '').toUpperCase();
                    let nome = (i.nome || '').toUpperCase();
                    return cat !== 'PAGAMENTO' && !nome.includes('PAGAMENTO PARCIAL') && i.codigo !== 'PAG_AVULSO' && i.total > 0;
                });
                let pagamentos = itens.filter(i => {
                    let cat = (i.category || i.categoria || i.cat || '').toUpperCase();
                    let nome = (i.nome || '').toUpperCase();
                    return (cat === 'PAGAMENTO' || nome.includes('PAGAMENTO PARCIAL') || i.codigo === 'PAG_AVULSO') && i.total != 0;
                });

                let html = produtos.map(i => {
                    t += i.total;
                    return `<tr><td>${i.nome}</td><td>${i.qtd}x</td><td align="right">R$ ${i.total.toFixed(2)}</td></tr>`;
                }).join('');

                if (pagamentos.length > 0) {
                    html += `<tr><td colspan="3" style="padding-top:10px; border-bottom:1px solid #000; font-weight:bold; font-size:10px;">PAGAMENTOS REALIZADOS:</td></tr>`;
                    let pgsVistos = new Set();
                    pagamentos.forEach(p => {
                        let v = Math.abs(p.total);
                        let chave = p.nome + "_" + v.toFixed(2);
                        if (!pgsVistos.has(chave)) {
                            t += p.total;
                            html += `<tr style="color:#28a745"><td>${p.nome}</td><td></td><td align="right">R$ -${v.toFixed(2)}</td></tr>`;
                            pgsVistos.add(chave);
                        }
                    });
                }

                document.getElementById('v-itens').innerHTML = html || '<tr><td colspan="3" align="center">Vazio</td></tr>';
                document.getElementById('v-total').innerText = 'Saldo Pendente: R$ ' + t.toFixed(2);
                document.getElementById('modalVisualizar').style.display = 'flex';
            }).buscarItensComanda(id);
        }

        function buscarVD(v) {
            let f = v ? estoqueCache.filter(p => p.nome.toLowerCase().includes(v.toLowerCase())) : estoqueCache;
            document.getElementById('vd-drop').innerHTML = f.map(p => `
                <div style="padding:15px; cursor:pointer; border-bottom:1px solid var(--glass); display:flex; gap:10px; align-items:center;" onclick="addVD('${p.codigo}')">
                    <img src="${p.imagem}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;">
                    <div><b>${p.nome}</b><br><small style="color:var(--primary)">R$ ${p.preco.toFixed(2)}</small></div>
                </div>
            `).join('');
            document.getElementById('vd-drop').style.display = 'block';
        }

        function addVD(cod) {
            let p = estoqueCache.find(x => x.codigo === cod);
            let item = carrinhoVD.find(x => x.codigo === cod);
            if (item) item.qtd++; else carrinhoVD.push({ ...p, qtd: 1 });
            renderVD(); document.getElementById('vd-drop').style.display = 'none';
            document.getElementById('vd-busca').value = '';
        }

        function renderVD() {
            let t = 0;
            document.querySelector('#vd-carrinho tbody').innerHTML = carrinhoVD.map(i => {
                t += (i.preco * i.qtd);
                return `<tr>
                    <td><b>${i.nome}</b></td>
                    <td style="white-space:nowrap">
                        <button class="btn btn-outline" style="padding: 2px 10px; font-size: 0.8rem; min-width: 30px;" onclick="updateVD('${i.codigo}', -1)">-</button>
                        <span style="display: inline-block; width: 30px; text-align: center; font-weight: 700;">${i.qtd}</span>
                        <button class="btn btn-outline" style="padding: 2px 10px; font-size: 0.8rem; min-width: 30px;" onclick="updateVD('${i.codigo}', 1)">+</button>
                    </td>
                    <td align="right">R$ ${(i.preco * i.qtd).toFixed(2)}</td>
                </tr>`;
            }).join('');
            document.getElementById('vd-total').innerText = 'R$ ' + t.toFixed(2);
        }

        function updateVD(cod, delta) {
            let item = carrinhoVD.find(x => x.codigo === cod);
            if (!item) return;
            item.qtd += delta;
            if (item.qtd <= 0) {
                carrinhoVD = carrinhoVD.filter(x => x.codigo !== cod);
            }
            renderVD();
        }

        function finalizarVD() {
            if (carrinhoVD.length === 0) return;
            let m = document.getElementById('vd-pagamento').value;
            let clie = document.getElementById('vd-cliente').value;
            if (m === 'Fiado' && !clie) { showToast("Informe o nome do cliente para Fiado!", "error"); return; }
            if (!confirm(`Confirmar venda no ${m}?`)) return;

            mostrarCarregando("Finalizando...");
            let t = parseFloat(document.getElementById('vd-total').innerText.replace('R$ ', ''));
            let dados = {
                id: 'VD' + new Date().getTime(),
                tipo: 'VENDA_DIRETA',
                total: t,
                forma: m,
                cliente: clie,
                pago: t,
                troco: 0,
                itens: carrinhoVD.map(it => ({
                    codigo: it.codigo,
                    nome: it.nome,
                    qtd: it.qtd,
                    preco: it.preco,
                    total: it.preco * it.qtd
                }))
            };
            google.script.run.withSuccessHandler(() => {
                esconderCarregando();
                carrinhoVD = [];
                document.getElementById('vd-cliente').value = '';
                toggleVdCliente();
                renderVD();
                carregarDash();
                carregarVDSerecente();
                showToast("Venda Direta realizada com sucesso!", "success");

                // Abrir recibo para impress√£o imediata
                visualizarVD(dados.id, 'Venda Direta');
            }).finalizarVenda(dados);
        }

        function carregarVDSerecente() {
            google.script.run.withSuccessHandler(lista => {
                if (!Array.isArray(lista)) {
                    document.getElementById('lista-vd-hist').innerHTML = 'Nenhuma venda recente.';
                    return;
                }
                let html = "";
                // Somente VENDAS DIRETAS (ID come√ßa com VD)
                lista.filter(c => c.id && String(c.id).startsWith('VD')).slice(0, 10).forEach(v => {
                    html += `
                        <div class="comanda-item" onclick="visualizarVD('${v.id}', 'Venda Direta')">
                            <span class="status-badge" style="background:rgba(212,175,55,0.1); color:var(--primary)">DIRETA</span>
                            <b>${v.id}</b><br>
                            <span style="font-weight:700">R$ ${v.total.toFixed(2)}</span>
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;">${v.dataExibicao}</div>
                        </div>`;
                });
                document.getElementById('lista-vd-hist').innerHTML = html || 'Sem vendas recentes.';
            }).listarTodasComandas();
        }

        function visualizarVD(id, nome) {
            document.getElementById('v-nome').innerText = nome + " #" + id;
            document.getElementById('v-itens').innerHTML = '<tr><td colspan="3" align="center">Carregando...</td></tr>';
            document.getElementById('v-total').innerText = 'Total: R$ 0,00';

            google.script.run.withSuccessHandler(itens => {
                let t = 0;
                document.getElementById('v-itens').innerHTML = itens.map(i => {
                    t += i.total;
                    return `<tr><td>${i.nome}</td><td>${i.qtd}x</td><td align="right">R$ ${i.total.toFixed(2)}</td></tr>`;
                }).join('');
                document.getElementById('v-total').innerText = 'Total: R$ ' + t.toFixed(2);
                document.getElementById('modalVisualizar').style.display = 'flex';
            }).buscarItensComanda(id);
        }

        function restaurarSistema() { if (confirm("CUIDADO: Isso limpa tudo. Continuar?")) google.script.run.withSuccessHandler(() => location.reload()).criarEstrutura(); }
        function limparFiltro() {
            document.getElementById('dash-inicio').value = '';
            document.getElementById('dash-fim').value = '';
            carregarDash();
        }

        function setFiltroHoje() {
            const hoje = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Bahia' });
            document.getElementById('dash-inicio').value = hoje;
            document.getElementById('dash-fim').value = hoje;
            carregarDash();
        }

        function setFiltroMes() {
            const d = new Date();
            const inicio = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-01';
            const hoje = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Bahia' });
            document.getElementById('dash-inicio').value = inicio;
            document.getElementById('dash-fim').value = hoje;
            carregarDash();
        }

        function toggleComandas() {
            const container = document.getElementById('container-comandas-hist');
            const txt = document.getElementById('txt-toggle');
            const icon = document.getElementById('icon-toggle');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                txt.innerText = 'Recolher';
                icon.className = 'fas fa-chevron-up';
            } else {
                container.style.display = 'none';
                txt.innerText = 'Expandir';
                icon.className = 'fas fa-chevron-down';
            }
        }
        function fecharModais() { document.querySelectorAll('.overlay').forEach(m => m.style.display = 'none'); }

        function carregarTudo() {
            // Setar data de hoje por padr√£o nos filtros (Salvador/BA)
            const hoje = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Bahia' });
            document.getElementById('dash-inicio').value = hoje;
            document.getElementById('dash-fim').value = hoje;

            carregarDash();
            carregarEstoque();
            carregarVDSerecente();
            checarNotificacoes();
        }



        // Controle de Navega√ß√£o do Portal
        function irParaModulo(p) {
            // Se estiver na Vercel, as p√°ginas est√£o na mesma pasta
            if (window.location.hostname !== 'script.google.com') {
                window.location.href = p + ".html";
            } else {
                // Se estiver no Google, usa o par√¢metro page
                google.script.run.withSuccessHandler(url => {
                    window.top.location.href = url + "?page=" + p;
                }).getScriptUrl();
            }
        }

        function irParaLogin() {
            document.getElementById('view-portal').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('login-pass').focus();
        }

        function voltarAoPortal() {
            sessionStorage.removeItem('auth_admin');
            document.getElementById('view-admin').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('view-portal').style.display = 'flex';
        }

        function tentarLogin() {
            const pass = document.getElementById('login-pass').value;
            const btn = document.querySelector('.login-box button');
            const err = document.getElementById('login-err');

            if (!pass) return;

            // Verificar se o ambiente do Google est√° dispon√≠vel
            if (typeof google === 'undefined' || !google.script) {
                alert("AVISO: O sistema n√£o detectou o ambiente do Google Apps Script. Se voc√™ est√° testando localmente ou na Vercel, a senha n√£o poder√° ser validada. Use o link oficial do Google Script (Execu√ß√£o).");
                btn.innerHTML = 'ENTRAR';
                btn.disabled = false;
                return;
            }

            btn.innerHTML = 'VALIDANDO...';
            btn.disabled = true;
            err.style.display = 'none';

            google.script.run
                .withSuccessHandler(res => {
                    if (res.sucesso) {
                        sessionStorage.setItem('auth_admin', 'true');
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('view-admin').style.display = 'block';
                        carregarTudo();
                    } else {
                        btn.innerHTML = 'ENTRAR';
                        btn.disabled = false;
                        err.style.display = 'block';
                        document.getElementById('login-pass').value = '';
                    }
                })
                .withFailureHandler(e => {
                    btn.innerHTML = 'ENTRAR';
                    btn.disabled = false;
                    alert("Erro no servidor: " + e.message);
                })
                .verificarSenha(pass, 'admin');
        }

        window.onload = () => {
            if (sessionStorage.getItem('auth_admin') === 'true') {
                document.getElementById('view-portal').style.display = 'none';
                document.getElementById('view-admin').style.display = 'block';
                carregarTudo();
            } else {
                document.getElementById('view-portal').style.display = 'flex';
            }

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('<?= ScriptApp.getService().getUrl() ?>?page=sw')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('Erro SW', err));
            }

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                // Mostrar o bot√£o de instala√ß√£o
                document.getElementById('install-button').style.display = 'block';
            });

            document.getElementById('install-button').addEventListener('click', async () => {
                if (!deferredPrompt) {
                    return;
                }
                // Mostrar o prompt de instala√ß√£o
                deferredPrompt.prompt();
                // Aguardar a escolha do usu√°rio
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                // Limpar o prompt
                deferredPrompt = null;
                // Esconder o bot√£o ap√≥s a instala√ß√£o
                document.getElementById('install-button').style.display = 'none';
            });

            // Esconder o bot√£o se o app j√° estiver instalado
            window.addEventListener('appinstalled', () => {
                console.log('PWA foi instalado');
                document.getElementById('install-button').style.display = 'none';
            });
        };
        function toggleVdCliente() {
            const m = document.getElementById('vd-pagamento').value;
            document.getElementById('vd-cliente-cont').style.display = m === 'Fiado' ? 'block' : 'none';
        }
    </script>
</body>

</html>